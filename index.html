<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asteroid Blaster - Enhanced</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: linear-gradient(to bottom, #0c0c0c, #1a1a2e, #16213e);
            color: white;
            font-family: 'Courier New', monospace;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            overflow: hidden;
            flex-direction: row; /* Arrange items in a row */
        }

        .game-container {
            display: flex; /* Use flexbox for game container */
            flex-direction: row; /* Default for larger screens */
            text-align: center;
            background: rgba(0, 0, 0, 0.3);
            padding: 20px;
            border-radius: 15px;
            border: 2px solid #00ffff;
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.3);
            align-items: flex-start; /* Align items to the top */
            max-width: 95%;
            margin: 10px;
        }

        .game-header {
            margin-bottom: 15px;
            /* display: grid; */ /* Remove grid for header as it will be in sidebar */
            /* grid-template-columns: 1fr 1fr 1fr; */
            /* gap: 15px; */
            display: flex; /* Use flex for vertical stacking in sidebar */
            flex-direction: column;
            gap: 15px;
            text-align: left;
        }

        .game-header h1 {
            /* grid-column: 1 / -1; */ /* Remove grid specific styling */
            margin: 0;
            font-size: 2.2em;
            color: #00ffff;
            text-shadow: 0 0 10px #00ffff;
        }

        .sidebar {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 20px;
            margin-left: 30px; /* Space between canvas and sidebar */
            padding: 20px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            border: 2px solid #00ffff;
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.3);
            min-width: 250px;
            text-align: left;
        }

        .stat-box {
            background: rgba(0, 255, 255, 0.1);
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #00ffff;
            width: 100%;
            box-sizing: border-box;
        }

        .score {
            font-size: 1.1em;
            margin: 5px 0;
            color: #ffff00;
        }

        .level-info {
            color: #00ff00;
            font-size: 1.1em;
        }

        .upgrade-info {
            color: #ff69b4;
            font-size: 0.9em;
        }

        .main-game-area {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            position: relative; /* Add this to make it a positioning context */
        }

        #gameCanvas {
            border: 2px solid #00ffff;
            background: #000;
            border-radius: 8px;
            box-shadow: inset 0 0 50px rgba(0, 255, 255, 0.1);
            width: 100%; /* Make canvas responsive */
            height: auto; /* Maintain aspect ratio */
            max-width: 900px; /* Original max width */
            max-height: 900px; /* Original max height */
        }

        .controls {
            margin-top: 15px;
            font-size: 0.8em;
            color: #ccc;
            line-height: 1.4;
            text-align: center;
        }

        .start-btn, .restart-btn {
            background: linear-gradient(45deg, #00ffff, #0080ff);
            color: #000;
            border: none;
            padding: 12px 24px;
            font-size: 1.1em;
            font-weight: bold;
            border-radius: 25px;
            cursor: pointer;
            margin: 10px;
            transition: all 0.3s;
            box-shadow: 0 0 15px rgba(0, 255, 255, 0.3);
            position: absolute; /* Position over the canvas */
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 10; /* Ensure it's above the canvas */
        }

        .game-over {
            color: #ff4444;
            font-size: 1.5em;
            margin: 15px 0;
        }

        .level-up {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 255, 0, 0.9);
            color: #000;
            padding: 20px;
            border-radius: 10px;
            font-size: 1.5em;
            font-weight: bold;
            z-index: 1000;
            animation: levelUpPulse 2s ease-out;
        }

        @keyframes levelUpPulse {
            0% { opacity: 0; transform: translate(-50%, -50%) scale(0.5); }
            50% { opacity: 1; transform: translate(-50%, -50%) scale(1.1); }
            100% { opacity: 0; transform: translate(-50%, -50%) scale(1); }
        }

        .hidden {
            opacity: 0;
            pointer-events: none;
        }

        .stars {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
        }

        .upgrade-notification {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            white-space: nowrap;
            box-sizing: border-box;
            padding: 5px 10px;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 5px;
            border: 1px solid #ff69b4;
            color: #ff69b4;
            font-size: 0.9em;
            margin-top: 5px;
            text-shadow: 0 0 5px #ff69b4;
            transition: opacity 0.3s ease-in-out;
            opacity: 1;
        }

        /* Media queries for responsiveness */
        @media (max-width: 768px) {
            body {
                flex-direction: column;
            }

            .game-container {
                flex-direction: column; /* Stack elements vertically on small screens */
                padding: 10px;
                margin: 5px;
            }

            .sidebar {
                margin-left: 0;
                margin-top: 20px;
                width: 100%;
                min-width: unset;
            }

            .game-header h1 {
                font-size: 1.8em;
            }

            .stat-box {
                flex-direction: row;
                justify-content: space-around;
                flex-wrap: wrap;
            }

            .controls {
                margin-top: 10px;
            }
        }

        @media (max-width: 480px) {
            .game-header h1 {
                font-size: 1.5em;
            }

            .stat-box {
                flex-direction: column;
                align-items: flex-start;
            }

            .score, .level-info, .upgrade-info {
                font-size: 0.9em;
            }
        }
    </style>
</head>
<body>
    
    <div class="stars" id="stars"></div>
    
    <div class="game-container">
        <div class="main-game-area">
            <canvas id="gameCanvas" width="900" height="900"></canvas>
            
            <button class="start-btn" id="startBtn" onclick="startGame()">START GAME</button>
            
            <div class="game-over hidden" id="gameOverDiv">
                <div>GAME OVER</div>
                <div id="finalStats"></div>
                <button class="restart-btn" onclick="startGame()">PLAY AGAIN</button>
            </div>
        </div>

        <div class="sidebar">
            <div class="game-header">
                <h1>ðŸš€ ASTEROID BLASTER ENHANCED</h1>
                
                <div class="stat-box">
                    <div class="score">Score: <span id="score">0</span></div>
                    <div class="score">Lives: <span id="lives">3</span></div>
                </div>
                
                <div class="stat-box">
                    <div class="level-info">Level: <span id="level">1</span></div>
                    <div class="level-info">Progress: <span id="progress">0</span>/100</div>
                </div>
                
                <div class="stat-box">
                    <div class="upgrade-info">Ship: <span id="shipType">Basic</span></div>
                    <div class="upgrade-info">Weapon: <span id="weaponType">Single</span></div>
                    <!-- <div class="upgrade-info">Speed: <span id="speedLevel">1</span></div> -->
                </div>
            </div>

            <div class="controls">
                WASD or Arrow Keys to move
                ðŸŽ¯ Destroy asteroids to gain XP and unlock upgrades!<br>
                ðŸ’Ž Collect power-ups for temporary boosts<br>
                ðŸ”´ Weapon â€¢ ðŸ©· Health â€¢ ðŸ”µ Fire Rate
            </div>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        // UI Elements
        const scoreEl = document.getElementById('score');
        const livesEl = document.getElementById('lives');
        const levelEl = document.getElementById('level');
        const progressEl = document.getElementById('progress');
        const shipTypeEl = document.getElementById('shipType');
        const weaponTypeEl = document.getElementById('weaponType');
        // const speedLevelEl = document.getElementById('speedLevel');
        const startBtn = document.getElementById('startBtn');
        const gameOverDiv = document.getElementById('gameOverDiv');
        const finalStatsEl = document.getElementById('finalStats');
        // const upgradeNotificationEl = document.getElementById('upgradeNotification');

        let gameState = {
            running: false,
            score: 0,
            lives: 3,
            level: 1,
            xp: 0,
            xpToNext: 100,
            player: { 
                x: 450, 
                y: 850, 
                size: 15, 
                speed: 4, // Adjusted from 8 to 4 for slower movement
                shipType: 'basic',
                weaponLevel: 1,
                // speedLevel: 1,
                fireRate: 120
            },
            bullets: [],
            asteroids: [],
            powerUps: [],
            keys: {},
            // spacePressed: false,
            lastShot: 0
        };

        // Ship types and their properties
        const shipTypes = {
            basic: { name: 'Basic', color: '#00ffff', size: 15 },
            fighter: { name: 'Fighter', color: '#ff6b6b', size: 18 },
            destroyer: { name: 'Destroyer', color: '#4ecdc4', size: 22 },
            battleship: { name: 'Battleship', color: '#ffd93d', size: 25 }
        };

        // Weapon types
        const weaponTypes = {
            1: { name: 'Single', bullets: 1, spread: 0, fireRate: 120, bulletColor: '#ffff00', bulletSize: {width: 4, height: 12}, damage: 1 },
            2: { name: 'Double', bullets: 2, spread: 15, fireRate: 100, bulletColor: '#ffdd00', bulletSize: {width: 4, height: 12}, damage: 1 },
            3: { name: 'Triple', bullets: 3, spread: 25, fireRate: 90, bulletColor: '#ffaa00', bulletSize: {width: 5, height: 14}, damage: 1 },
            4: { name: 'Spread', bullets: 5, spread: 40, fireRate: 80, bulletColor: '#ff7700', bulletSize: {width: 6, height: 16}, damage: 1 },
            5: { name: 'Laser', bullets: 1, spread: 0, fireRate: 50, bulletColor: '#ff00ff', bulletSize: {width: 6, height: 20}, damage: 2 }, // Faster, stronger single shot
            6: { name: 'Plasma', bullets: 3, spread: 30, fireRate: 70, bulletColor: '#00ff00', bulletSize: {width: 8, height: 16}, damage: 2 }, // Wider, slower bullets, high damage
            7: { name: 'Wave', bullets: 1, spread: 60, fireRate: 100, bulletColor: '#00ffff', bulletSize: {width: 10, height: 10}, damage: 1, wave: true }, // New wave weapon
            8: { name: 'Cannon', bullets: 1, spread: 0, fireRate: 200, bulletColor: '#ffa500', bulletSize: {width: 12, height: 24}, damage: 3 } // Slow, powerful single shot
        };

        function createStars() {
            const starsContainer = document.getElementById('stars');
            for (let i = 0; i < 100; i++) {
                const star = document.createElement('div');
                star.style.position = 'absolute';
                star.style.width = '2px';
                star.style.height = '2px';
                star.style.background = '#fff';
                star.style.left = Math.random() * 100 + '%';
                star.style.top = Math.random() * 100 + '%';
                star.style.animation = `twinkle ${Math.random() * 3 + 1}s infinite`;
                starsContainer.appendChild(star);
            }
        }

        const style = document.createElement('style');
        style.textContent = `
            @keyframes twinkle {
                0%, 100% { opacity: 0.3; }
                50% { opacity: 1; }
            }
        `;
        document.head.appendChild(style);

        function spawnAsteroid() {
            const baseSize = 20 + Math.random() * 30;
            const levelMultiplier = 1 + (gameState.level - 1) * 0.1;
            const size = baseSize * levelMultiplier;
            const baseSpeed = 1 + Math.random() * 2;
            const speed = baseSpeed * (1 + gameState.level * 0.05);
            
            const asteroid = {
                x: Math.random() * (canvas.width - size),
                y: -size,
                size: size,
                speed: speed,
                rotation: 0,
                rotSpeed: (Math.random() - 0.5) * 0.2,
                hp: Math.floor(size / 30) + 1
            };
            gameState.asteroids.push(asteroid);
        }

        function spawnPowerUp(x, y) {
            if (Math.random() < 0.3) { // 30% chance
                const types = ['weapon', 'health', 'shield', 'weaponChange']; // Added weaponChange
                const type = types[Math.floor(Math.random() * types.length)];
                gameState.powerUps.push({
                    x: x,
                    y: y,
                    type: type,
                    size: 20,
                    rotation: 0
                });
            }
        }

        function drawPlayer() {
            const ship = shipTypes[gameState.player.shipType];
            const size = ship.size;
            
            ctx.fillStyle = ship.color;
            ctx.strokeStyle = ship.color;
            ctx.lineWidth = 2;
            
            // Draw ship based on type
            ctx.beginPath();
            if (gameState.player.shipType === 'basic') {
                ctx.moveTo(gameState.player.x, gameState.player.y - size);
                ctx.lineTo(gameState.player.x - size, gameState.player.y + size);
                ctx.lineTo(gameState.player.x, gameState.player.y + size/2);
                ctx.lineTo(gameState.player.x + size, gameState.player.y + size);
            } else if (gameState.player.shipType === 'fighter') {
                ctx.moveTo(gameState.player.x, gameState.player.y - size);
                ctx.lineTo(gameState.player.x - size/2, gameState.player.y);
                ctx.lineTo(gameState.player.x - size, gameState.player.y + size);
                ctx.lineTo(gameState.player.x, gameState.player.y + size/2);
                ctx.lineTo(gameState.player.x + size, gameState.player.y + size);
                ctx.lineTo(gameState.player.x + size/2, gameState.player.y);
            } else {
                // Advanced ships - more complex design
                ctx.rect(gameState.player.x - size/2, gameState.player.y - size, size, size * 2);
            }
            ctx.closePath();
            ctx.fill();
            ctx.stroke();
            
            // Add glow effect
            ctx.shadowColor = ship.color;
            ctx.shadowBlur = 10;
            ctx.fill();
            ctx.shadowBlur = 0;
        }

        function drawBullet(bullet) {
            ctx.fillStyle = bullet.color || '#ffff00';
            ctx.shadowColor = bullet.color || '#ffff00';
            ctx.shadowBlur = 5;

            if (bullet.wave) {
                ctx.beginPath();
                ctx.arc(bullet.x, bullet.y, bullet.size.width / 2, 0, Math.PI * 2);
                ctx.fill();
            } else {
                ctx.fillRect(bullet.x - (bullet.size.width / 2), bullet.y - (bullet.size.height / 2), bullet.size.width, bullet.size.height);
            }
            
            ctx.shadowBlur = 0;
        }

        function drawAsteroid(asteroid) {
            ctx.save();
            ctx.translate(asteroid.x, asteroid.y);
            ctx.rotate(asteroid.rotation);
            
            // Color based on HP
            const hpRatio = asteroid.hp / Math.floor(asteroid.size / 30 + 1);
            const red = Math.floor(255 * (1 - hpRatio));
            const green = Math.floor(128 * hpRatio);
            ctx.fillStyle = `rgb(${128 + red}, ${green}, ${green})`;
            ctx.strokeStyle = '#aaa';
            ctx.lineWidth = 2;
            
            ctx.beginPath();
            const points = 8;
            for (let i = 0; i < points; i++) {
                const angle = (i / points) * Math.PI * 2;
                const radius = asteroid.size + Math.sin(angle * 3) * (asteroid.size * 0.2);
                const x = Math.cos(angle) * radius;
                const y = Math.sin(angle) * radius;
                
                if (i === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            }
            ctx.closePath();
            ctx.fill();
            ctx.stroke();
            ctx.restore();
        }

        function drawPowerUp(powerUp) {
            const colors = {
                weapon: '#ff0000', 
                health: '#ff69b4',
                shield: '#0080ff',
                weaponChange: '#39ff14' // Neon green
            };
            
            ctx.save();
            ctx.translate(powerUp.x, powerUp.y);
            ctx.rotate(powerUp.rotation);
            
            ctx.fillStyle = colors[powerUp.type];
            ctx.shadowColor = colors[powerUp.type];
            ctx.shadowBlur = 8;
            
            // Draw diamond shape
            ctx.beginPath();
            ctx.moveTo(0, -powerUp.size);
            ctx.lineTo(powerUp.size, 0);
            ctx.lineTo(0, powerUp.size);
            ctx.lineTo(-powerUp.size, 0);
            ctx.closePath();
            ctx.fill();
            
            ctx.shadowBlur = 0;
            ctx.restore();
        }

        function updatePlayer() {
            if (gameState.keys['a'] || gameState.keys['A'] || gameState.keys['ArrowLeft']) {
                gameState.player.x = Math.max(gameState.player.size, gameState.player.x - gameState.player.speed);
            }
            if (gameState.keys['d'] || gameState.keys['D'] || gameState.keys['ArrowRight']) {
                gameState.player.x = Math.min(canvas.width - gameState.player.size, gameState.player.x + gameState.player.speed);
            }
            if (gameState.keys['w'] || gameState.keys['W'] || gameState.keys['ArrowUp']) {
                gameState.player.y = Math.max(gameState.player.size, gameState.player.y - gameState.player.speed);
            }
            if (gameState.keys['s'] || gameState.keys['S'] || gameState.keys['ArrowDown']) {
                gameState.player.y = Math.min(canvas.height - gameState.player.size, gameState.player.y + gameState.player.speed);
            }
        }

        function updateBullets() {
            for (let i = gameState.bullets.length - 1; i >= 0; i--) {
                const bullet = gameState.bullets[i];
                bullet.x += bullet.dx;
                bullet.y += bullet.dy;
                
                if (bullet.y < 0 || bullet.x < 0 || bullet.x > canvas.width) {
                    gameState.bullets.splice(i, 1);
                }
            }
        }

        function updateAsteroids() {
            for (let i = gameState.asteroids.length - 1; i >= 0; i--) {
                const asteroid = gameState.asteroids[i];
                asteroid.y += asteroid.speed;
                asteroid.rotation += asteroid.rotSpeed;
                
                if (asteroid.y > canvas.height + asteroid.size) {
                    gameState.asteroids.splice(i, 1);
                }
            }
        }

        function updatePowerUps() {
            const attractionRadius = 100; // Power-ups attract when within this distance
            const attractionSpeed = 3; // How fast power-ups move towards the player

            for (let i = gameState.powerUps.length - 1; i >= 0; i--) {
                const powerUp = gameState.powerUps[i];
                powerUp.y += 2;
                powerUp.rotation += 0.1;

                const dx = gameState.player.x - powerUp.x;
                const dy = gameState.player.y - powerUp.y;
                const distance = Math.sqrt(dx * dx + dy * dy);

                if (distance < attractionRadius) {
                    // Move power-up towards the player
                    if (distance > 1) { // Avoid division by zero if distance is 0
                        powerUp.x += (dx / distance) * attractionSpeed;
                        powerUp.y += (dy / distance) * attractionSpeed;
                    }
                }
                
                if (powerUp.y > canvas.height) {
                    gameState.powerUps.splice(i, 1);
                }
            }
        }

        function checkCollisions() {
            // Bullet-asteroid collisions
            for (let i = gameState.bullets.length - 1; i >= 0; i--) {
                const bullet = gameState.bullets[i];
                for (let j = gameState.asteroids.length - 1; j >= 0; j--) {
                    const asteroid = gameState.asteroids[j];
                    const dx = bullet.x - asteroid.x;
                    const dy = bullet.y - asteroid.y;
                    const distance = Math.sqrt(dx * dx + dy * dy);
                    
                    if (distance < asteroid.size) {
                        gameState.bullets.splice(i, 1);
                        asteroid.hp -= bullet.damage || 1; // Use bullet damage, default to 1
                        
                        if (asteroid.hp <= 0) {
                            const points = Math.floor(asteroid.size / 5);
                            gameState.score += points;
                            gameState.xp += points;
                            scoreEl.textContent = gameState.score;
                            
                            spawnPowerUp(asteroid.x, asteroid.y);
                            gameState.asteroids.splice(j, 1);
                            
                            // Check level up
                            if (gameState.xp >= gameState.xpToNext) {
                                levelUp();
                            }
                        }
                        break;
                    }
                }
            }
            
            // Player-asteroid collisions
            for (let i = gameState.asteroids.length - 1; i >= 0; i--) {
                const asteroid = gameState.asteroids[i];
                const dx = gameState.player.x - asteroid.x;
                const dy = gameState.player.y - asteroid.y;
                const distance = Math.sqrt(dx * dx + dy * dy);
                
                if (distance < asteroid.size + gameState.player.size) {
                    gameState.asteroids.splice(i, 1);
                    gameState.lives--;
                    livesEl.textContent = gameState.lives;
                    
                    if (gameState.lives <= 0) {
                        gameOver();
                        return;
                    }
                }
            }
            
            // Player-powerup collisions
            for (let i = gameState.powerUps.length - 1; i >= 0; i--) {
                const powerUp = gameState.powerUps[i];
                const dx = gameState.player.x - powerUp.x;
                const dy = gameState.player.y - powerUp.y;
                const distance = Math.sqrt(dx * dx + dy * dy);
                
                if (distance < powerUp.size + gameState.player.size) {
                    collectPowerUp(powerUp.type);
                    gameState.powerUps.splice(i, 1);
                }
            }
        }

        function collectPowerUp(type) {
            // let message = '';
            switch(type) {
                case 'weapon':
                    if (gameState.player.weaponLevel < 8) { // Increased max weapon level
                        gameState.player.weaponLevel++;
                        updateWeaponDisplay();
                        // message = 'Weapon Upgrade!';
                    } else {
                        gameState.score += 50;
                        // message = '+50 Points!';
                    }
                    break;
                case 'health':
                    gameState.lives = Math.min(5, gameState.lives + 1);
                    livesEl.textContent = gameState.lives;
                    // message = 'Extra Life!';
                    break;
                case 'shield':
                    gameState.player.fireRate = Math.max(50, gameState.player.fireRate - 20);
                    // message = 'Fire Rate Boost!';
                    break;
                case 'weaponChange':
                    gameState.player.weaponLevel++;
                    if (gameState.player.weaponLevel > Object.keys(weaponTypes).length) {
                        gameState.player.weaponLevel = 1; // Cycle back to the first weapon
                    }
                    updateWeaponDisplay();
                    break;
            }
            
            // showUpgradeNotification(message);
        }

        // function showUpgradeNotification(message) {
        //     upgradeNotificationEl.textContent = message;
        //     upgradeNotificationEl.classList.remove('hidden');
        //     setTimeout(() => {
        //         upgradeNotificationEl.classList.add('hidden');
        //     }, 2000);
        // }

        function levelUp() {
            gameState.level++;
            gameState.xp = 0;
            gameState.xpToNext = gameState.level * 100;
            
            // Ship upgrades based on level
            if (gameState.level === 5) {
                gameState.player.shipType = 'fighter';
            } else if (gameState.level === 10) {
                gameState.player.shipType = 'destroyer';
            } else if (gameState.level === 15) {
                gameState.player.shipType = 'battleship';
            }
            
            updateDisplays();
            showLevelUpAnimation();
        }

        function showLevelUpAnimation() {
            const levelUpEl = document.createElement('div');
            levelUpEl.className = 'level-up';
            levelUpEl.textContent = `LEVEL ${gameState.level}!`;
            document.body.appendChild(levelUpEl);
            
            setTimeout(() => {
                document.body.removeChild(levelUpEl);
            }, 2000);
        }

        function updateDisplays() {
            levelEl.textContent = gameState.level;
            progressEl.textContent = gameState.xp;
            shipTypeEl.textContent = shipTypes[gameState.player.shipType].name;
            updateWeaponDisplay();
            // speedLevelEl.textContent = gameState.player.speedLevel;
        }

        function updateWeaponDisplay() {
            weaponTypeEl.textContent = weaponTypes[gameState.player.weaponLevel].name;
        }

        function shoot() {
            const weapon = weaponTypes[gameState.player.weaponLevel];
            const bulletSpeed = 8;
            
            if (weapon.bullets === 1) {
                gameState.bullets.push({
                    x: gameState.player.x,
                    y: gameState.player.y - gameState.player.size,
                    dx: 0,
                    dy: -bulletSpeed,
                    color: weapon.bulletColor,
                    size: weapon.bulletSize,
                    damage: weapon.damage // Add damage property
                });
            } else {
                // Multi-shot weapons
                for (let i = 0; i < weapon.bullets; i++) {
                    const angle = (i - (weapon.bullets - 1) / 2) * (weapon.spread * Math.PI / 180) / (weapon.bullets - 1);
                    gameState.bullets.push({
                        x: gameState.player.x,
                        y: gameState.player.y - gameState.player.size,
                        dx: Math.sin(angle) * bulletSpeed * 0.5,
                        dy: -bulletSpeed * Math.cos(angle),
                        color: weapon.bulletColor,
                        size: weapon.bulletSize,
                        damage: weapon.damage // Add damage property
                    });
                }
            }
        }

        function gameLoop() {
            if (!gameState.running) return;
            
            ctx.fillStyle = 'rgba(0, 0, 0, 0.1)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            updatePlayer();
            
            // Handle continuous shooting (auto-fire)
            const now = Date.now();
            if (now - gameState.lastShot > gameState.player.fireRate) {
                shoot();
                gameState.lastShot = now;
            }
            
            updateBullets();
            updateAsteroids();
            updatePowerUps();
            checkCollisions();
            
            drawPlayer();
            gameState.bullets.forEach(drawBullet);
            gameState.asteroids.forEach(drawAsteroid);
            gameState.powerUps.forEach(drawPowerUp);
            
            // Dynamic asteroid spawning
            const spawnRate = 0.02 + gameState.level * 0.005;
            if (Math.random() < spawnRate) {
                spawnAsteroid();
            }
            
            // Update progress bar
            progressEl.textContent = `${gameState.xp}/${gameState.xpToNext}`;
            
            requestAnimationFrame(gameLoop);
        }

        function startGame() {
            gameState = {
                running: true,
                score: 0,
                lives: 3,
                level: 1,
                xp: 0,
                xpToNext: 100,
                player: { 
                    x: 450, 
                    y: 850, 
                    size: 15, 
                    speed: 4, // Adjusted from 8 to 4 for slower movement
                    shipType: 'basic',
                    weaponLevel: 1,
                    // speedLevel: 1,
                    fireRate: 120
                },
                bullets: [],
                asteroids: [],
                powerUps: [],
                keys: {},
                // spacePressed: false,
                lastShot: 0
            };
            
            updateDisplays();
            scoreEl.textContent = '0';
            livesEl.textContent = '3';
            startBtn.classList.add('hidden');
            gameOverDiv.classList.add('hidden');
            
            gameLoop();
        }

        function gameOver() {
            gameState.running = false;
            finalStatsEl.innerHTML = `
                Final Level: ${gameState.level}<br>
                Ship Type: ${shipTypes[gameState.player.shipType].name}<br>
                Weapon Level: ${weaponTypes[gameState.player.weaponLevel].name}
            `;
            gameOverDiv.classList.remove('hidden');
        }

        // Event listeners for keyboard
        document.addEventListener('keydown', (e) => {
            gameState.keys[e.key] = true;
            
            // Removed spacebar functionality
        });

        document.addEventListener('keyup', (e) => {
            gameState.keys[e.key] = false;
            
            // Removed spacebar functionality
        });

        // Touch controls
        let touchStartX = 0;
        let touchStartY = 0;
        let touchEndX = 0;
        let touchEndY = 0;

        canvas.addEventListener('touchstart', (e) => {
            e.preventDefault();
            touchStartX = e.touches[0].clientX;
            touchStartY = e.touches[0].clientY;
        });

        canvas.addEventListener('touchmove', (e) => {
            e.preventDefault();
            touchEndX = e.touches[0].clientX;
            touchEndY = e.touches[0].clientY;
            handleTouchMove();
        });

        canvas.addEventListener('touchend', (e) => {
            e.preventDefault();
            // Reset touch state if needed
            gameState.keys = {}; // Clear movement keys on touch release
        });

        function handleTouchMove() {
            const deltaX = touchEndX - touchStartX;
            const deltaY = touchEndY - touchStartY;

            // Determine direction based on touch swipe
            gameState.keys = {}; // Clear previous keys
            if (Math.abs(deltaX) > Math.abs(deltaY)) {
                // Horizontal swipe
                if (deltaX > 0) {
                    gameState.keys['ArrowRight'] = true; // Move right
                } else {
                    gameState.keys['ArrowLeft'] = true; // Move left
                }
            } else {
                // Vertical swipe
                if (deltaY > 0) {
                    gameState.keys['ArrowDown'] = true; // Move down
                } else {
                    gameState.keys['ArrowUp'] = true; // Move up
                }
            }
            // For continuous movement, update start to current end
            touchStartX = touchEndX;
            touchStartY = touchEndY;
        }

        // Initialize
        createStars();
        ctx.fillStyle = '#000';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
    </script>
</body>
</html>